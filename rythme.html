<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#FFE5CC">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon-180.png">
    <link rel="apple-touch-icon" sizes="192x192" href="apple-touch-icon-192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="apple-touch-icon-512.png">
    <title>Exercice de Rythme - SolFun</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Quicksand:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --pastel-pink: #FFD4E5;
            --pastel-blue: #B4D4FF;
            --pastel-lavender: #E5D4FF;
            --pastel-peach: #FFE5CC;
            --pastel-mint: #D4FFEA;
            --soft-purple: #9B86BD;
            --deep-blue: #6B9BD1;
            --white: #FFFFFF;
            --text-dark: #4A4A68;
            --text-light: #7A7A9E;
            --success-green: #7FD89A;
            --error-red: #FF9B9B;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Quicksand', sans-serif;
            background: linear-gradient(135deg, var(--pastel-peach) 0%, var(--pastel-pink) 100%);
            min-height: 100vh;
            padding: 20px;
            -webkit-text-size-adjust: 100%;
        }

        .top-bar {
            max-width: 900px;
            margin: 0 auto 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 20px 30px;
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(155, 134, 189, 0.15);
        }

        .score-display {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .score-item {
            text-align: center;
        }

        .score-label {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 5px;
        }

        .score-value {
            font-family: 'Fredoka', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--soft-purple);
        }

        .quit-button {
            background: var(--error-red);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 12px;
            font-family: 'Fredoka', sans-serif;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .exercise-card {
            background: white;
            border-radius: 30px;
            padding: 50px;
            box-shadow: 0 15px 40px rgba(155, 134, 189, 0.2);
            margin-bottom: 30px;
        }

        .metronome-controls {
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: center;
            margin-top: 15px;
        }

        .metronome-button {
            background: white;
            border: 2px solid var(--soft-purple);
            padding: 12px 30px;
            border-radius: 15px;
            font-family: 'Fredoka', sans-serif;
            font-size: 1.1rem;
            color: var(--soft-purple);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .metronome-button.active {
            background: var(--soft-purple);
            color: white;
        }

        .bpm-control {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .bpm-button {
            width: 40px;
            height: 40px;
            background: white;
            border: 2px solid var(--soft-purple);
            border-radius: 10px;
            font-size: 1.2rem;
            color: var(--soft-purple);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .bpm-display {
            font-family: 'Fredoka', sans-serif;
            font-size: 2rem;
            font-weight: 700;
            color: white;
            min-width: 100px;
        }

        .rhythm-display {
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 30px 0;
            background: linear-gradient(135deg, var(--pastel-mint) 0%, var(--pastel-blue) 100%);
            border-radius: 20px;
            padding: 40px;
        }

        .measure-display {
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .rhythm-svg {
            width: 100%;
            max-width: 400px;
            height: 150px;
        }

        .tap-zone {
            background: var(--pastel-peach);
            border: 3px dashed var(--soft-purple);
            border-radius: 20px;
            padding: 60px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        .tap-zone:active {
            transform: scale(0.95);
            background: var(--pastel-pink);
        }

        .tap-zone-text {
            font-family: 'Fredoka', sans-serif;
            font-size: 1.5rem;
            color: var(--soft-purple);
            margin-bottom: 10px;
        }

        .tap-hint {
            color: var(--text-light);
            font-size: 1rem;
        }

        .answers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 20px;
            margin-top: 40px;
        }

        .answer-button {
            background: white;
            border: 3px solid var(--pastel-peach);
            padding: 25px;
            border-radius: 20px;
            font-family: 'Fredoka', sans-serif;
            font-size: 1.5rem;
            color: var(--soft-purple);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .answer-button.correct {
            background: var(--success-green);
            border-color: var(--success-green);
            color: white;
        }

        .answer-button.incorrect {
            background: var(--error-red);
            border-color: var(--error-red);
            color: white;
        }

        @keyframes noteAppear {
            from { opacity: 0; transform: scale(0.5); }
            to { opacity: 1; transform: scale(1); }
        }

        .note-figure {
            animation: noteAppear 0.5s ease-out;
        }

        .metronome-control {
            background: linear-gradient(135deg, var(--pastel-lavender) 0%, var(--pastel-pink) 100%);
            border-radius: 20px;
            padding: 25px;
            margin: 20px 0;
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        .metronome-header {
            font-family: 'Fredoka', sans-serif;
            font-size: 1.3rem;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .metronome-controls {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }

        .bpm-control {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .bpm-button {
            background: white;
            border: 2px solid var(--soft-purple);
            color: var(--soft-purple);
            width: 40px;
            height: 40px;
            border-radius: 10px;
            font-family: 'Fredoka', sans-serif;
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .bpm-button:hover,
        .bpm-button:active {
            background: var(--soft-purple);
            color: white;
            transform: scale(1.1);
        }

        .bpm-input {
            width: 80px;
            padding: 10px;
            border: 2px solid var(--soft-purple);
            border-radius: 10px;
            font-family: 'Fredoka', sans-serif;
            font-size: 1.5rem;
            text-align: center;
            color: var(--text-dark);
        }

        .metronome-toggle {
            background: var(--success-green);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 12px;
            font-family: 'Fredoka', sans-serif;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .metronome-toggle:hover,
        .metronome-toggle:active {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(127, 216, 154, 0.4);
        }

        .metronome-toggle.playing {
            background: var(--error-red);
        }

        .metronome-beat {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--soft-purple);
            opacity: 0.3;
            transition: all 0.1s ease;
        }

        .metronome-beat.active {
            opacity: 1;
            transform: scale(1.5);
        }

        @media (max-width: 768px) {
            .exercise-card {
                padding: 25px;
            }

            .tap-zone {
                padding: 40px 20px;
            }

            .metronome-control {
                padding: 20px 15px;
            }

            .metronome-controls {
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="score-display">
            <div class="score-item">
                <div class="score-label">Mode</div>
                <div class="score-value" id="mode-display">Figures</div>
            </div>
            <div class="score-item">
                <div class="score-label">Score</div>
                <div class="score-value" id="score-display">0/0</div>
            </div>
            <div class="score-item">
                <div class="score-label">Série</div>
                <div class="score-value" id="streak-display"><span data-icon="fire" data-icon-size="sm"></span> 0</div>
            </div>
        </div>
        <button class="quit-button" onclick="quitExercise()">✕ Quitter</button>
    </div>

    <div class="container">
        <div class="exercise-card">
            <div class="question-header" style="text-align: center; margin-bottom: 30px;">
                <h2 class="question-text" id="question-text" style="font-family: 'Fredoka', sans-serif; font-size: 1.8rem; color: var(--text-dark);">
                    Quelle est cette figure rythmique ? <span data-icon="drum" data-icon-size="sm"></span>
                </h2>
            </div>

            <div class="rhythm-display" id="rhythm-display">
                <!-- Figures rythmiques affichées ici -->
            </div>

            <div id="tap-zone-container" style="display: none;">
                <div class="tap-zone" id="tap-zone" onclick="handleTap()" onkeydown="handleKeyTap(event)" tabindex="0">
                    <div class="tap-zone-text">Tape le rythme ici !</div>
                    <div class="tap-hint">Clique ou appuie sur Espace</div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="metronome-button" onclick="finishTapping()">✓ Terminer</button>
                </div>
            </div>

            <!-- Métronome -->
            <div class="metronome-control">
                <div class="metronome-header">
                    <span data-icon="timer" data-icon-size="sm"></span>
                    Métronome
                </div>
                <div class="metronome-controls">
                    <div class="bpm-control">
                        <button class="bpm-button" onclick="adjustBPM(-10)">−10</button>
                        <button class="bpm-button" onclick="adjustBPM(-1)">−</button>
                        <input type="number" id="bpm-input" class="bpm-input" value="60" min="40" max="140" step="1" onchange="updateBPM()">
                        <button class="bpm-button" onclick="adjustBPM(1)">+</button>
                        <button class="bpm-button" onclick="adjustBPM(10)">+10</button>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <div class="metronome-beat" id="beat-indicator"></div>
                        <button class="metronome-toggle" id="metronome-toggle" onclick="toggleMetronome()">
                            <span data-icon="play" data-icon-size="sm"></span>
                            <span id="metronome-status">Démarrer</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="answers-grid" id="answers-grid">
                <!-- Boutons générés dynamiquement -->
            </div>
        </div>
    </div>

    <div class="feedback-message" id="feedback" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); background: white; padding: 40px 60px; border-radius: 25px; box-shadow: 0 20px 60px rgba(155, 134, 189, 0.4); z-index: 1000; text-align: center; transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);">
        <div class="feedback-icon" id="feedbackIcon" data-icon="celebration" data-icon-size="xl" style="margin-bottom: 20px; display: flex; justify-content: center;"></div>
        <div class="feedback-text" id="feedbackText" style="font-family: 'Fredoka', sans-serif; font-size: 2rem; color: var(--text-dark);">Bravo !</div>
    </div>

    <script src="icons.js"></script>
    <script src="app.js"></script>
    <script>
        // Fallback pour navigateTo si app.js ne se charge pas
        if (typeof navigateTo === 'undefined') {
            function navigateTo(page) {
                window.location.href = page;
            }
        }

        // Configuration des exercices
        const rhythmExercises = {
            figures: {
                name: 'Figures',
                question: 'Quelle est cette figure rythmique ?',
                figures: [
                    { name: 'Ronde', beats: 4, symbol: 'whole' },
                    { name: 'Blanche', beats: 2, symbol: 'half' },
                    { name: 'Noire', beats: 1, symbol: 'quarter' }
                ]
            },
            counting: {
                name: 'Comptage',
                question: 'Combien de temps compte cette mesure ?'
            },
            tapping: {
                name: 'Frappe',
                question: 'Reproduis ce rythme en tapant !'
            }
        };

        let currentMode = 'figures';
        let currentFigure = null;
        let currentMeasure = null;
        let questionCount = 0;
        const maxQuestions = 15;

        // Variables pour la frappe de rythme
        let tapTimes = [];
        let expectedRhythm = [];
        let tapStartTime = 0;
        let isTapping = false;

        // Dessiner figures rythmiques
        function drawRhythmFigure(symbol) {
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('class', 'rhythm-svg note-figure');
            svg.setAttribute('viewBox', '0 0 100 100');

            const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            g.setAttribute('transform', 'translate(50, 50)');

            if (symbol === 'whole') {
                const ellipse = document.createElementNS('http://www.w3.org/2000/svg', 'ellipse');
                ellipse.setAttribute('cx', '0');
                ellipse.setAttribute('cy', '0');
                ellipse.setAttribute('rx', '18');
                ellipse.setAttribute('ry', '13');
                ellipse.setAttribute('fill', 'none');
                ellipse.setAttribute('stroke', '#4A4A68');
                ellipse.setAttribute('stroke-width', '3');
                g.appendChild(ellipse);
            } else if (symbol === 'half') {
                const ellipse = document.createElementNS('http://www.w3.org/2000/svg', 'ellipse');
                ellipse.setAttribute('cx', '0');
                ellipse.setAttribute('cy', '0');
                ellipse.setAttribute('rx', '18');
                ellipse.setAttribute('ry', '13');
                ellipse.setAttribute('fill', 'none');
                ellipse.setAttribute('stroke', '#4A4A68');
                ellipse.setAttribute('stroke-width', '3');
                g.appendChild(ellipse);

                const stem = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                stem.setAttribute('x1', '17');
                stem.setAttribute('y1', '0');
                stem.setAttribute('x2', '17');
                stem.setAttribute('y2', '-35');
                stem.setAttribute('stroke', '#4A4A68');
                stem.setAttribute('stroke-width', '2.5');
                g.appendChild(stem);
            } else if (symbol === 'quarter') {
                const ellipse = document.createElementNS('http://www.w3.org/2000/svg', 'ellipse');
                ellipse.setAttribute('cx', '0');
                ellipse.setAttribute('cy', '0');
                ellipse.setAttribute('rx', '18');
                ellipse.setAttribute('ry', '13');
                ellipse.setAttribute('fill', '#4A4A68');
                g.appendChild(ellipse);

                const stem = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                stem.setAttribute('x1', '17');
                stem.setAttribute('y1', '0');
                stem.setAttribute('x2', '17');
                stem.setAttribute('y2', '-35');
                stem.setAttribute('stroke', '#4A4A68');
                stem.setAttribute('stroke-width', '2.5');
                g.appendChild(stem);
            }

            svg.appendChild(g);
            return svg;
        }

        function generateQuestion() {
            if (questionCount >= maxQuestions) {
                endExercise();
                return;
            }

            const modes = ['figures', 'counting', 'tapping'];
            currentMode = modes[questionCount % 3];

            const config = rhythmExercises[currentMode];
            document.getElementById('mode-display').textContent = config.name;
            document.getElementById('question-text').innerHTML = config.question + ' <span data-icon="drum" data-icon-size="sm"></span>';
            SolFunIcons.replaceIconPlaceholders();

            const rhythmDisplay = document.getElementById('rhythm-display');
            const answersGrid = document.getElementById('answers-grid');
            const tapZoneContainer = document.getElementById('tap-zone-container');

            rhythmDisplay.innerHTML = '';
            answersGrid.innerHTML = '';
            rhythmDisplay.style.display = 'flex';
            tapZoneContainer.style.display = 'none';
            answersGrid.style.display = 'grid';

            if (currentMode === 'figures') {
                currentFigure = config.figures[Math.floor(Math.random() * config.figures.length)];
                const figure = drawRhythmFigure(currentFigure.symbol);
                rhythmDisplay.appendChild(figure);

                config.figures.forEach(fig => {
                    const button = document.createElement('button');
                    button.className = 'answer-button';
                    button.textContent = fig.name;
                    button.onclick = () => checkAnswer(fig.name, button);
                    answersGrid.appendChild(button);
                });
            } else if (currentMode === 'counting') {
                const numNotes = Math.floor(Math.random() * 3) + 2;
                const notes = [];
                let totalBeats = 0;

                // Générer une mesure aléatoire
                const allFigures = rhythmExercises.figures.figures;
                for (let i = 0; i < numNotes && totalBeats < 4; i++) {
                    const availableFigures = allFigures.filter(f => totalBeats + f.beats <= 4);
                    if (availableFigures.length === 0) break;
                    const fig = availableFigures[Math.floor(Math.random() * availableFigures.length)];
                    notes.push(fig);
                    totalBeats += fig.beats;
                }

                currentMeasure = { notes, totalBeats };

                const measureDiv = document.createElement('div');
                measureDiv.className = 'measure-display';
                notes.forEach(note => {
                    const fig = drawRhythmFigure(note.symbol);
                    measureDiv.appendChild(fig);
                });
                rhythmDisplay.appendChild(measureDiv);

                for (let i = 1; i <= 4; i++) {
                    const button = document.createElement('button');
                    button.className = 'answer-button';
                    button.textContent = i + ' temps';
                    button.onclick = () => checkAnswer(i, button);
                    answersGrid.appendChild(button);
                }
            } else if (currentMode === 'tapping') {
                // Mode frappe de rythme
                const pattern = generateTapPattern();
                currentMeasure = pattern;

                const measureDiv = document.createElement('div');
                measureDiv.className = 'measure-display';
                pattern.notes.forEach(note => {
                    const fig = drawRhythmFigure(note.symbol);
                    measureDiv.appendChild(fig);
                });
                rhythmDisplay.appendChild(measureDiv);

                setTimeout(() => {
                    rhythmDisplay.style.display = 'none';
                    tapZoneContainer.style.display = 'block';
                    answersGrid.style.display = 'none';
                    startTapping();
                }, 3000); // Afficher le rythme pendant 3 secondes
            }

            questionCount++;
        }

        function generateTapPattern() {
            const patterns = [
                { notes: [{ symbol: 'quarter' }, { symbol: 'quarter' }, { symbol: 'half' }], beats: [1, 1, 2] },
                { notes: [{ symbol: 'half' }, { symbol: 'quarter' }, { symbol: 'quarter' }], beats: [2, 1, 1] },
                { notes: [{ symbol: 'quarter' }, { symbol: 'half' }, { symbol: 'quarter' }], beats: [1, 2, 1] }
            ];
            return patterns[Math.floor(Math.random() * patterns.length)];
        }

        function startTapping() {
            tapTimes = [];
            tapStartTime = Date.now();
            isTapping = true;
            document.getElementById('tap-zone').focus();
        }

        function handleTap() {
            if (!isTapping) return;
            const now = Date.now();
            tapTimes.push(now - tapStartTime);
            playMetronomeClick();
        }

        function handleKeyTap(event) {
            if (event.code === 'Space') {
                event.preventDefault();
                handleTap();
            }
        }

        function finishTapping() {
            isTapping = false;
            analyzeTapAccuracy();
        }

        function analyzeTapAccuracy() {
            if (tapTimes.length < 2) {
                checkAnswer(0, null);
                return;
            }

            const intervals = [];
            for (let i = 1; i < tapTimes.length; i++) {
                intervals.push(tapTimes[i] - tapTimes[i - 1]);
            }

            // Simple accuracy check: did they tap the right number of times?
            const expectedTaps = currentMeasure.notes.length;
            const actualTaps = tapTimes.length;

            const accuracy = Math.abs(expectedTaps - actualTaps) === 0 ? 100 :
                           Math.abs(expectedTaps - actualTaps) === 1 ? 70 : 50;

            checkAnswer(accuracy, null);
        }

        function checkAnswer(selectedAnswer, button) {
            let isCorrect = false;

            if (currentMode === 'figures') {
                isCorrect = selectedAnswer === currentFigure.name;
            } else if (currentMode === 'counting') {
                isCorrect = selectedAnswer === currentMeasure.totalBeats;
            } else if (currentMode === 'tapping') {
                isCorrect = selectedAnswer >= 70; // 70% accuracy or better
            }

            if (button) {
                document.querySelectorAll('.answer-button').forEach(btn => btn.disabled = true);
            }

            const feedback = document.getElementById('feedback');
            const feedbackIcon = document.getElementById('feedbackIcon');
            const feedbackText = document.getElementById('feedbackText');

            if (isCorrect) {
                if (button) button.classList.add('correct');
                feedbackIcon.innerHTML = SolFunIcons.celebration('xl');
                feedbackText.textContent = currentMode === 'tapping' ?
                    'Excellent rythme !' : 'Bravo ! C\'est la bonne réponse !';
                if (typeof sound !== 'undefined') sound.playSuccess();
                if (typeof app !== 'undefined') app.updateStats(true);
            } else {
                if (button) button.classList.add('incorrect');
                feedbackIcon.innerHTML = SolFunIcons.oops('xl');
                feedbackText.textContent = currentMode === 'tapping' ?
                    'Presque ! Continue de t\'entraîner !' :
                    (currentMode === 'figures' ? 'C\'était ' + currentFigure.name + ' !' :
                     'C\'était ' + currentMeasure.totalBeats + ' temps !');
                if (typeof sound !== 'undefined') sound.playError();
                if (typeof app !== 'undefined') app.updateStats(false);
            }

            updateScoreDisplay();
            feedback.style.transform = 'translate(-50%, -50%) scale(1)';

            setTimeout(() => {
                feedback.style.transform = 'translate(-50%, -50%) scale(0)';
                setTimeout(generateQuestion, 400);
            }, 2500);
        }

        function updateScoreDisplay() {
            if (typeof app === 'undefined' || !app.state.currentSession) return;

            const session = app.state.currentSession;
            document.getElementById('score-display').textContent = `${session.score}/${session.total}`;
            document.getElementById('streak-display').innerHTML = `${SolFunIcons.fire('sm')} ${session.streak}`;
        }

        function endExercise() {
            if (typeof app === 'undefined' || !app.state.currentSession) {
                alert('Erreur : Session non initialisée');
                navigateTo('index.html');
                return;
            }

            const session = app.state.currentSession;
            const successRate = session.total > 0 ? Math.round((session.score / session.total) * 100) : 0;

            alert(`Exercice terminé !\nScore : ${session.score}/${session.total} (${successRate}%)`);
            navigateTo('index.html');
        }

        function quitExercise() {
            if (confirm('Es-tu sûr de vouloir quitter cet exercice ?')) {
                stopMetronome();
                navigateTo('index.html');
            }
        }

        // Métronome
        let metronomeInterval = null;
        let metronomeBPM = 60;
        let metronomeAudioContext = null;

        function initMetronome() {
            // Créer un contexte audio pour le métronome
            if (!metronomeAudioContext) {
                metronomeAudioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function adjustBPM(delta) {
            const input = document.getElementById('bpm-input');
            let newBPM = parseInt(input.value) + delta;
            newBPM = Math.max(40, Math.min(140, newBPM));
            input.value = newBPM;
            updateBPM();
        }

        function updateBPM() {
            const input = document.getElementById('bpm-input');
            let bpm = parseInt(input.value);

            // Valider la plage
            if (isNaN(bpm) || bpm < 40) bpm = 40;
            if (bpm > 140) bpm = 140;

            input.value = bpm;
            metronomeBPM = bpm;

            // Si le métronome est en cours, le redémarrer avec le nouveau tempo
            if (metronomeInterval) {
                stopMetronome();
                startMetronome();
            }
        }

        function toggleMetronome() {
            if (metronomeInterval) {
                stopMetronome();
            } else {
                startMetronome();
            }
        }

        function startMetronome() {
            initMetronome();

            const toggle = document.getElementById('metronome-toggle');
            const status = document.getElementById('metronome-status');
            toggle.classList.add('playing');
            status.textContent = 'Arrêter';

            const interval = (60 / metronomeBPM) * 1000;

            // Jouer le premier tick immédiatement
            playMetronomeTick();

            metronomeInterval = setInterval(() => {
                playMetronomeTick();
            }, interval);
        }

        function stopMetronome() {
            if (metronomeInterval) {
                clearInterval(metronomeInterval);
                metronomeInterval = null;

                const toggle = document.getElementById('metronome-toggle');
                const status = document.getElementById('metronome-status');
                const beat = document.getElementById('beat-indicator');

                toggle.classList.remove('playing');
                status.textContent = 'Démarrer';
                beat.classList.remove('active');
            }
        }

        function playMetronomeTick() {
            // Effet visuel
            const beat = document.getElementById('beat-indicator');
            beat.classList.add('active');
            setTimeout(() => {
                beat.classList.remove('active');
            }, 100);

            // Son du métronome
            if (metronomeAudioContext) {
                const oscillator = metronomeAudioContext.createOscillator();
                const gainNode = metronomeAudioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(metronomeAudioContext.destination);

                oscillator.frequency.value = 800;
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.3, metronomeAudioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, metronomeAudioContext.currentTime + 0.1);

                oscillator.start(metronomeAudioContext.currentTime);
                oscillator.stop(metronomeAudioContext.currentTime + 0.1);
            }
        }

        // Initialiser quand le DOM et les scripts sont prêts
        function initializeExercise() {
            // S'assurer que app est chargé
            if (typeof app === 'undefined') {
                console.error('app.js n\'est pas chargé !');
                return;
            }

            // Initialiser la session
            if (!app.state.currentSession) {
                app.state.currentSession = { level: 0, score: 0, total: 0, streak: 0 };
            } else {
                app.state.currentSession.score = 0;
                app.state.currentSession.total = 0;
                app.state.currentSession.streak = 0;
            }
            app.saveState();

            // Générer la première question
            generateQuestion();

            // Remplacer les icônes
            if (typeof SolFunIcons !== 'undefined') {
                SolFunIcons.replaceIconPlaceholders();
            }
        }

        // Attendre que le DOM soit chargé
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeExercise);
        } else {
            // DOM déjà chargé
            initializeExercise();
        }

        // Cleanup on exit
        window.addEventListener('beforeunload', () => {
            stopMetronome();
        });
    </script>
</body>
</html>
